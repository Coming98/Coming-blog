---
title: 01-活跃主机发现技术
mathjax: false
date: 2022-07-15 13:07:04
summary: Nmap-活跃主机发现技术
categories: Kali
tags:
  - nmap
---

# 活跃主机发现技术

活跃主机: 那些已经于运行状态并且网络功能正常的主机

协议与约定: 协议中明确规定了如果一台计算机收到来自另一台计算机的特定格式数据包后应该如何处理
- 所有的协议规范都可以参考 Request For Comments (RFC）

Tips: Nmap 会首先判断目标主机与 Nmap 所在主机是否在同一网段，如果相同的话，则直接使用 ARP 扫描模式

## 快速的活跃主机发现

Nmap 在扫描时，默认会将目标端口等信息也扫描出来, 这样速度就会慢下来, 因此如果只想知道目标主机集合是否存在活跃主机的化, 可以使用 `-sn` 参数

```shell
nmap -sn 192.168.80.0/24
```

# 基于 ARP

ARP: 解决逻辑地址 (IP) 和物理地址 (MAC) 的转换关系
- 同一网段中的通信一般使用物理地址，不同网段之间的通信一般使用逻辑地址
- 为什么不只用一个地址: 同网段通信不必先经过互联网在转回来（不必快递员参与）

交换机: 内容寻址寄存器中存储了每个接口所连接的主机的物理地址表, 通过 ARP 获取每个接口所连接的物理地址

原理: ARP 在本网段内对目标 IP 广播请求包, 目标 IP 接收后如果活跃就必须回应（如果违反 ARP 这个约定, 将意味着无法通信）,如果没有回应, 则目标 IP 不在线

## 主机发现

`nmap -PR -sn 192.168.80.6`: 先发送 `who has 192.168.80.6 tell ${me}` 目标接收到会响应 `ARP Reply 192.168.80.6 is-at ${MAC}`

![](https://raw.githubusercontent.com/Coming98/pictures/main/202207150944059.png)

# 基于 ICMP

ICMP: Internet Control Message Protocol, 在IP主机、路由器之间传递控制消息

报文种类繁多:

![](https://raw.githubusercontent.com/Coming98/pictures/main/202207150947418.png)

原理: 使用 ICMP 的查询报文
- 响应请求和应答: （ping) 测试发送与接收两端链路及目标主机 TCP/IP 协议是否正常，只要收到就是正常
- 时间戳请求和应答: 向另一个系统查询当前的时间, 返回的建议值是自午夜开始计算的毫秒数，即协调世界时（Coordinated Universal Time, UTC）
- 地址掩码请求和应答: 用于无盘系统在引导过程中获取自己的子网掩码

## 主机发现

```shell
nmap -PE -sn 192.168.80.132 # 基于请求与应答查询报文
nmap -PP -sn 192.168.80.132 # 基于时间戳请求与应答查询报文
nmap -PM -sn 192.168.80.132 # 基于地址掩码请求与应答查询报文
```

# 基于 TCP

TCP: Transmission Control Protocol，传输控制协议

原理: 向目标主机的一部分常用端口发送连接请求数据包，如果得到回应（注意**只要收到了数据包**），就可以认为主机 B 是活跃主机

## 常用端口

![](https://raw.githubusercontent.com/Coming98/pictures/main/202207151113401.png)

## 主机发现

### SYN + RST

`-PS`: 向目标主机发送一个设置了 SYN 标志的数据包(内容部分为空, 默认的目标端口是 80)
- 可以使用参数来改变目标端口, 当指定多个端口时，Nmap 将会并发地对这些端口进行测试
- 如果端口开放：响应 SYN/ACK 数据包，表示同意建立连接, 本地响应 RST 结束连接
- 如果端口关闭：响应 RST 数据包，表示拒绝连接
- 但是无论端口是否开放, 只要有响应都表示主机活跃

![](https://raw.githubusercontent.com/Coming98/pictures/main/202207151110352.png)

### ACK

`-PA`: 直接向目标主机发送一个 ACK 数据包，目标主机显然无法清楚这是怎么回事，当然也不可能成功建立 TCP 连接，因此只能向 Nmap 所在主机发送一个 RST 标志位的数据包，表示无法建立这个 TCP 连接
- 不推荐使用, 因为可能会被防火墙过滤掉而导致响应的情况多样

# 基于 UDP

UDP: 非面向连接的, 使得 UDP 端口扫描的可靠性不高

原理: 当一个 UDP 端口收到一个 UDP 数据包时，如果它是关闭的，就会给源端发回一个 ICMP 端口不可达数据包；如果它是开放的，就会忽略这个数据包，也就是将它丢弃而不返回任何信息
- 但是不返回任何信息可能表示这个数据包在传输过程中丢失了或者被防火墙拦截了
- 此外确定不返回任何信息所需要的时间也很长, 因此扫描效率降低

## 主机发现

- `-PU`: 

# 基于 SCTP

SCTP: 与 TCP 同属于传输层上的协议，与 TCP 完成的任务是相同的，但两者之间却存在着很大的不同之处
- TCP 协议一般是用于单地址连接的，而 SCTP 却可以用于多地址连接
- TCP 协议是基于字节流的，SCTP 是基于消息流的
- TCP 只能支持一个流，而 SCTP 连接（association）同时可以支持多个流（stream）
- TCP 连接的建立是通过三次握手实现的，而 SCTP 是通过一种 4 次握手的机制实现的，这种机制可以有效避免攻击的产生

流程: 
1. 客户端使用一个 INIT 报文发起一个连接
2. 服务器端使用一个 INIT-ACK 报文进行应答，其中就包括了 cookie（标识这个连接的唯一上下文）
3. 客户端使用一个 COOKIE-ECHO 报文进行响应，其中包含了服务器端所发送的 cookie
4. 服务器端要为这个连接分配资源，并通过向客户端发送一个 COOKIE-ACK 报文对其进行响应

## 主机发现

- `-PY`: 目前支持这个协议的主机并不多，因此这种方法只能作为一种备用手段

# 基于 IP 协议

IP 协议: 是 TCP/IP 协议族中的核心协议，也是 TCP/IP 的载体。所有的 TCP、UDP、ICMP 及 IGMP 数据都以 IP 数据包格式传输
- 协议域: 标识是哪个协议向 IP 传送数据, ICMP(1), IGMP(2), TCP(6), UDP(17), GRE(47), ESP(50)

![](https://raw.githubusercontent.com/Coming98/pictures/main/202207151152444.png)

原理: Nmap 允许向目标主机发送 IP 数据包来检测目标主机是否活跃, 默认使用 ICMP、IGMP 和 IP-in-IP（IP协议编号4）三个协议，另外也可以使用参数 `-PO` 来指定所要使用协议的编号，例如默认的 IP 扫描方式

## 主机发现

指定 IP 协议进行主机发现：

```shell
nmap -sP -PO 192.168.80.132
nmap -sP -PO 1,2,4 192.168.80.132
```

默认情况 IP 包中的数据都是空的, 因此可以使用 `--data-length` 来设置随机数据的长度

```shell
nmap -sP -PO --data-length 25 192.168.80.132
```

# 主机域名解析

- `-R` 参数: 将扫描的 IP 集合无论是否是活跃主机, 都尝试列出主机对应的域名（将会耗费大量时间）
- `-n`: 取消对域名的转换
- `--dns-servers`: 指定某一个 DNS 服务查询目标域名

```shell
# 多个 DNS 服务器使用 逗号 分割
nmap --packet-trace -R --dns-servers 202.99.160.68 192.168.80.132
```

# Tips

- `--packet-trace` 选项: 可以观察 Nmap 发出了哪些数据包，收到了哪些数据包

![](https://raw.githubusercontent.com/Coming98/pictures/main/202207151305994.png)